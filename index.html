<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location and Date Selector</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>Select location and infection date</h1>
    <label for="location">Location:</label>
    <select id="location" onchange="loadCSV()">
        <option value="ny_heat.csv"data-start="09-01">New York City</option>
        <option value="stockholm_heat.csv"data-start="10-01">Stockholm</option>
        <option value="southkorea_heat.csv"data-start="09-01">South Korea</option>
        <option value="edinburgh_heat.csv"data-start="10-01">Edinburgh</option>
        <option value="yamagata_heat.csv"data-start="10-01">Yamagata</option>
        <option value="nepal_heat.csv"data-start="09-01">Nepal</option>
        <option value="guangzhou_heat.csv"data-start="10-01">Guangzhou</option>
        <option value="norway_heat.csv"data-start="10-01">Norway</option>
        <option value="netherlands_heat.csv"data-start="10-01">Netherlands</option>
        <option value="sweden_heat.csv"data-start="11-01">Gothenburg</option>
        <option value="israel_heat.csv"data-start="02-01">Israel</option>
        <!-- Add more locations as needed -->
    </select>

    <label for="day">Day of the Year:</label>
    <input type="date" id="day" onchange="findLowestValue()" disabled>

    <h2 id="result"></h2>

    <script>
        let csvData = [];
        let generatedHeaders = [];
        const currentYear = new Date().getFullYear();
        const nextYear = currentYear + 1;

        // Function to load CSV file based on selected location
        function loadCSV() {
            const locationSelect = document.getElementById('location');
            const location = locationSelect.value;
            const startDate = locationSelect.options[locationSelect.selectedIndex].dataset.start;
            const dateInput = document.getElementById('day');

            if (location) {
                const [startMonth, startDay] = startDate.split('-');
                const formattedStartDate = `${currentYear}-${startMonth}-${startDay}`;
                dateInput.min = formattedStartDate; // Set the minimum selectable date for the current year
                dateInput.max = `${nextYear}-12-31`; // Allow selection up to the end of next year
                dateInput.disabled = false; // Enable the date input
                dateInput.value = ""; // Reset date input value

                generateHeaders(startDate); // Generate headers based on the start date

                Papa.parse(location, {
                    download: true,
                    header: false, // Indicate that the CSV does not have headers
                    complete: function(results) {
                        csvData = results.data;
                        console.log("CSV Data Loaded:", csvData); // Debugging: check CSV data
                    }
                });
            } else {
                dateInput.disabled = true;
                dateInput.value = "";
                document.getElementById('result').innerText = '';
            }
        }

        // Function to generate date headers based on the start date
        function generateHeaders(startDate) {
            generatedHeaders = [];
            const [startMonth, startDay] = startDate.split('-');
            const startDateObj = new Date(currentYear, parseInt(startMonth) - 1, parseInt(startDay));

            for (let i = 0; i < csvData.length; i++) {
                let dateObj = new Date(startDateObj);
                dateObj.setDate(dateObj.getDate() + i);
                generatedHeaders.push(dateObj.toISOString().split('T')[0]); // Store dates in YYYY-MM-DD format
            }

            console.log("Generated Headers:", generatedHeaders); // Debugging: check generated headers
        }

        // Modified function to find the lowest value by using column indices
		function findLowestValue() {
		const selectedDate = document.getElementById('day').value;
		if (!selectedDate) {
			return; // Exit if no date is selected
		}

		// Debug: Log selected date
		console.log("Selected Date:", selectedDate);

		// Calculate the column index based on the selected date
		const startDate = new Date(generatedHeaders[0]); // Get the first generated date
		const selectedDateObj = new Date(selectedDate);
		const dateDiff = (selectedDateObj - startDate) / (1000 * 60 * 60 * 24); // Calculate the difference in days
		const dateColumnIndex = Math.round(dateDiff); // Round off to get the correct column index

		// Debug: Log calculated column index and generated headers
		console.log("Generated Headers:", generatedHeaders);
		console.log("Calculated Date Column Index:", dateColumnIndex);

		// Check if the column index is valid
		if (dateColumnIndex < 0 || dateColumnIndex >= csvData[0].length) {
			document.getElementById('result').innerText = 'Date not found in CSV data.';
			return;
		}

		let lowestValue = Infinity;
		let lowestDates = [];

		// Debug: Log csvData to check format
		console.log("CSV Data Length:", csvData.length);
		console.log("CSV Data Example Row:", csvData[0]);

		// Loop through the CSV data to find all rows with the lowest value for the selected date column
		csvData.forEach((row, rowIndex) => {
			const value = parseFloat(row[dateColumnIndex]);

			// Debug: Log row index and parsed value
			console.log(`Row ${rowIndex}, Column ${dateColumnIndex} Value:`, value);

			if (!isNaN(value)) {
				if (value < lowestValue) {
					lowestValue = value;
					lowestDates = [rowIndex]; // Reset the list with a new lowest value
				} else if (value === lowestValue) {
					lowestDates.push(rowIndex); // Add to the list if it's the same lowest value
				}
			}
		});

		// Display the range of dates with the lowest value
		if (lowestDates.length > 1) {
			document.getElementById('result').innerText = `Rows with the lowest value (${lowestValue}): ${lowestDates.join(', ')}`;
		} else if (lowestDates.length === 1) {
			document.getElementById('result').innerText = `Row with the lowest value (${lowestValue}): ${lowestDates[0]}`;
		} else {
			document.getElementById('result').innerText = 'No valid data found for the selected date.';
		}
	}
        // Helper function to find the column index of the selected date in the generated headers
        function findDateColumnIndex(selectedDate) {
            return generatedHeaders.indexOf(selectedDate);
        }

        // Helper function to generate the date for each row based on its index
        function generateDateForRow(rowIndex) {
            const baseDate = new Date(`${nextYear}-${generatedHeaders[0].split('-')[1]}-${generatedHeaders[0].split('-')[2]}`);
            baseDate.setDate(baseDate.getDate() + rowIndex);
            return baseDate.toISOString().split('T')[0];
        }
    </script>
</body>
</html>