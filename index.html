<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location and Date Selector</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pages-themes/cayman@0.2.0/assets/css/style.scss">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>

<body>
    <header>
        <div class="container">
            <h1 class="title">Select location and infection date</h1>
        </div>
    </header>

    <main>
        <div class="container">
            <label for="location">Location:</label>
            <select id="location" onchange="loadCSV()">
                <option value="" disabled selected>Location</option>
                <option value="ny_heat.csv" data-start="09-01">New York City</option>
                <option value="stockholm_heat.csv" data-start="10-01">Stockholm</option>
                <option value="southkorea_heat.csv" data-start="09-01">South Korea</option>
                <option value="edinburgh_heat.csv" data-start="10-01">Edinburgh</option>
                <option value="yamagata_heat.csv" data-start="10-01">Yamagata</option>
                <option value="nepal_heat.csv" data-start="09-01">Nepal</option>
                <option value="guangzhou_heat.csv" data-start="10-01">Guangzhou</option>
                <option value="norway_heat.csv" data-start="10-01">Norway</option>
                <option value="netherlands_heat.csv" data-start="10-01">Netherlands</option>
                <option value="sweden_heat.csv" data-start="11-01">Gothenburg</option>
                <option value="israel_heat.csv" data-start="02-01">Israel</option>
            </select>

            <label for="day">Infection date:</label>
            <input type="date" id="day" onchange="findLowestValue()" disabled>

            <h2 id="result"></h2>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Powered by PapaParse and GitHub Pages</p>
        </div>
    </footer>

    <script>
        let csvData = [];
        let generatedHeaders = [];
        const currentYear = new Date().getFullYear();
        const previousYear = currentYear - 1;

        function loadCSV() {
            const locationSelect = document.getElementById('location');
            const location = locationSelect.value;
            const startDate = locationSelect.options[locationSelect.selectedIndex].dataset.start;
            const dateInput = document.getElementById('day');

            if (location) {
                const [startMonth, startDay] = startDate.split('-');
                const formattedStartDate = `${previousYear}-${startMonth}-${startDay}`;
                dateInput.min = formattedStartDate;
                dateInput.max = `${currentYear}-12-31`;
                dateInput.disabled = true;

                generateHeaders(startDate);

                Papa.parse(location, {
                    download: true,
                    header: false,
                    complete: function(results) {
                        csvData = results.data;
                        console.log("CSV Data Loaded:", csvData);
                        dateInput.disabled = false;

                        if (dateInput.value) {
                            findLowestValue();
                        }
                    }
                });
            } else {
                dateInput.disabled = true;
                dateInput.value = "";
                document.getElementById('result').innerText = '';
            }
        }

        function generateHeaders(startDate) {
            generatedHeaders = [];
            const [startMonth, startDay] = startDate.split('-');
            const startDateObj = new Date(previousYear, parseInt(startMonth) - 1, parseInt(startDay));

            for (let i = 0; i < 365 * 2; i++) {
                let dateObj = new Date(startDateObj);
                dateObj.setDate(dateObj.getDate() + i);
                generatedHeaders.push(dateObj.toISOString().split('T')[0]);
            }

            console.log("Generated Headers:", generatedHeaders);
        }

        function findLowestValue() {
            const selectedDate = document.getElementById('day').value;
            if (!selectedDate) {
                return;
            }

            const selectedDateObj = new Date(selectedDate);
            const selectedYear = selectedDateObj.getFullYear();
            let baseDate;
            if (selectedYear === previousYear) {
                baseDate = new Date(`${currentYear}-${generatedHeaders[0].split('-')[1]}-${generatedHeaders[0].split('-')[2]}`);
            } else {
                baseDate = new Date(`${selectedYear}-${generatedHeaders[0].split('-')[1]}-${generatedHeaders[0].split('-')[2]}`);
            }

            const startDate = new Date(generatedHeaders[0]);
            const dateDiff = (selectedDateObj - startDate) / (1000 * 60 * 60 * 24);
            const dateColumnIndex = Math.round(dateDiff);

            if (dateColumnIndex < 0 || dateColumnIndex >= csvData[0].length) {
                document.getElementById('result').innerText = 'Date not found in CSV data.';
                return;
            }

            let lowestValue = Infinity;
            let lowestRowIndices = [];

            csvData.forEach((row, rowIndex) => {
                const value = parseFloat(row[dateColumnIndex]);
                if (!isNaN(value)) {
                    if (value < lowestValue) {
                        lowestValue = value;
                        lowestRowIndices = [rowIndex];
                    } else if (value === lowestValue) {
                        lowestRowIndices.push(rowIndex);
                    }
                }
            });

            const lowestDates = lowestRowIndices.map(rowIndex => {
                const date = new Date(baseDate);
                date.setDate(date.getDate() + rowIndex);
                return formatDateToReadable(date);
            });

            if (lowestDates.length > 1) {
                const firstDate = lowestDates[0];
                const lastDate = lowestDates[lowestDates.length - 1];
                document.getElementById('result').innerText = `You should receive your next booster between ${firstDate} and ${lastDate}`;
            } else if (lowestDates.length === 1) {
                document.getElementById('result').innerText = `You should receive your next booster on ${lowestDates[0]}`;
            } else {
                document.getElementById('result').innerText = 'No valid data found for the selected date.';
            }
        }

        function formatDateToReadable(date) {
            const options = { month: 'long', day: 'numeric' };
            const day = date.getDate();

            const suffix = (day % 10 === 1 && day !== 11) ? 'st' :
                           (day % 10 === 2 && day !== 12) ? 'nd' :
                           (day % 10 === 3 && day !== 13) ? 'rd' : 'th';

            return date.toLocaleDateString('en-US', options) + suffix + `, ${date.getFullYear()}`;
        }
    </script>
</body>

</html>
